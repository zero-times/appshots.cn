# AGENTS.team.md · appshots 团队协作版（Team Collaboration Playbook）

> 这是 appshots 的团队协作规范，重点解决 **人和流程**：角色分工、协作节奏、交付质量、沟通机制、上线与复盘。  
> 与 `AGENTS.md`（工程执行版）互补使用：
> - `AGENTS.md`：偏技术执行、架构约束、接口与规则
> - `AGENTS.team.md`：偏团队协作、职责边界、流程治理

---

## 1) 适用范围

适用于以下协作场景：
- 新需求从评审到上线
- 跨前后端联动改动（含 shared 类型）
- 权限、导出、项目归属等高风险变更
- 线上故障处理与复盘
- 新成员入项与协作对齐

---

## 2) 团队协作原则

1. **用户价值优先**：先交付可用闭环，再做局部完美。
2. **职责清晰**：谁拍板、谁执行、谁验收必须明确。
3. **小步快跑**：拆小任务、小 PR、快速反馈。
4. **信息透明**：关键决策有记录，状态可追踪。
5. **可回滚优先**：涉及核心链路必须能快速止损。

---

## 3) 角色与职责（RACI）

RACI 说明：
- **R** Responsible（执行）
- **A** Accountable（最终负责/拍板）
- **C** Consulted（被咨询）
- **I** Informed（被同步）

### 3.1 角色定义
- **PO/业务负责人**：需求价值、优先级、验收标准
- **Tech Lead**：技术方案、风险把控、质量门禁
- **FE Owner**：前端实现与交互一致性
- **BE Owner**：后端接口、权限、数据正确性
- **QA Owner**：测试设计、回归验证、发布验收
- **Release Owner**：发布计划、上线窗口、回滚指挥

### 3.2 RACI 矩阵

| 工作项 | PO | Tech Lead | FE Owner | BE Owner | QA Owner | Release Owner |
|---|---|---|---|---|---|---|
| 需求定义与优先级 | A/R | C | I | I | C | I |
| 技术方案评审 | C | A/R | C | C | C | I |
| 前端开发 | I | C | A/R | C | C | I |
| 后端开发 | I | C | C | A/R | C | I |
| 接口契约（shared） | C | A | R | R | C | I |
| 测试与回归 | C | C | C | C | A/R | I |
| 上线执行 | I | C | I | I | C | A/R |
| 事故响应 | I | A | R | R | C | R |
| 事故复盘 | C | A/R | C | C | C | I |

---

## 4) 需求协作流程（从想法到上线）

### 阶段 0：需求进入（Intake）
必须提供：
- 目标与成功指标（例：高级导出转化率、导出失败率）
- 用户画像与场景
- 非目标（明确不做什么）
- 依赖与风险（权限、限流、性能、数据迁移）

### 阶段 1：方案评审（Design Review）
输出物：
- 方案摘要（含备选方案与取舍）
- 影响面（client/server/shared/db）
- 风险与回滚策略
- 验证方案（自动 + 手工）

### 阶段 2：任务拆解（Execution Plan）
每个任务必须可独立验证：
- T1：契约/数据层
- T2：后端能力
- T3：前端交互
- T4：联调与验证

### 阶段 3：开发与联调
- 小 PR 优先（建议单 PR 控制在 200~500 行有效改动）
- 每次合入前必须更新风险与验证记录
- 跨端改动先对齐 shared，再分别实现

### 阶段 4：验收与发布
- QA 按验收清单执行冒烟 + 回归
- Release Owner 确认发布窗口、回滚路径
- 上线后 30~60 分钟重点监控

---

## 5) 协作节奏（Rituals）

### 5.1 日常同步（Async Standup）
统一模板：
- 昨日完成：
- 今日计划：
- 风险/阻塞：
- 需要谁协助：

要求：阻塞超过半天必须升级到 Tech Lead/PO。

### 5.2 周计划（Weekly Planning）
- 输入：需求池、线上问题、技术债
- 输出：本周 Top 3 目标 + Owner + 截止时间
- 原则：同一周期内避免并行推进过多高风险项

### 5.3 版本评审（Release Review）
- 发布内容（功能/修复/风险）
- 验证结论
- 发布窗口与回滚负责人

### 5.4 复盘（Retrospective）
- 做得好：继续放大
- 做得差：明确改进项与 Owner
- 下次改什么：形成行动项并跟踪关闭

---

## 6) 分支、提交与 PR 规范

## 6.1 分支命名
推荐：
- `feature/<topic>`
- `fix/<topic>`
- `chore/<topic>`
- `hotfix/<topic>`

若使用 Codex 自动分支，遵循 `codex/<topic>`。

## 6.2 提交信息（建议）
- `feat:` 新功能
- `fix:` 缺陷修复
- `refactor:` 重构
- `docs:` 文档
- `chore:` 工程杂项

示例：
- `feat: restrict advanced export for authenticated users`
- `fix: add 5-minute cooldown for advanced export API`

## 6.3 PR 必填项
- 变更背景与目标
- 影响范围（client/server/shared/db）
- 风险点与回滚策略
- 验证证据（命令输出/截图/步骤）
- 是否更新文档（`AGENTS.md` / `AGENTS.team.md`）

---

## 7) 质量门禁（Quality Gates）

最低门禁：
- `pnpm typecheck` 通过
- 核心链路手工冒烟通过

涉及权限/归属/导出的高风险改动，必须额外验证：
1. 未登录与已登录权限边界
2. 跨账号访问隔离（项目不可越权）
3. 限流是否符合预期（401/429 行为正确）
4. 失败场景的提示是否可理解

---

## 8) 验收定义（Definition of Done）

一个需求可关闭，必须同时满足：
- 功能行为符合验收标准
- 权限边界与异常场景可验证
- 文档已更新（至少一处：工程版或团队版）
- 回滚方案已明确（高风险改动必需）
- 相关 owner（PO/QA/Tech Lead）已知会

---

## 9) 沟通协议（Communication Protocol）

### 9.1 渠道分工（可映射到飞书/Slack）
- `#appshots-dev`：开发讨论与联调
- `#appshots-release`：发布计划与结果
- `#appshots-incident`：线上事故与应急
- `#appshots-decisions`：架构/产品决策存档

### 9.2 响应时效（SLO）
- 普通协作问题：4 小时内响应
- 阻塞问题：1 小时内响应
- 线上事故：15 分钟内拉群并开始处理

### 9.3 决策记录（Decision Log）
每个关键决策至少记录：
- 背景
- 选项与取舍
- 最终决策
- 影响面
- Owner 与日期

---

## 10) 风险管理与升级机制

### 10.1 风险分级
- **Low**：局部 UI/文案，不影响核心链路
- **Medium**：单端逻辑改动，影响可控
- **High**：权限、归属、导出、数据结构改动
- **Critical**：可能导致数据错误、越权、全链路故障

### 10.2 升级触发条件
出现以下情况立即升级到 Tech Lead + Release Owner：
- 核心链路失败率显著上升
- 出现越权或数据污染风险
- 无法在 30 分钟内定位问题
- 回滚失败或不可回滚

---

## 11) 线上事故流程（Incident Playbook）

1. **确认影响面**：谁受影响、哪个功能、持续多久
2. **建立战情通道**：指定 Incident Commander
3. **止血优先**：降级、开关、回滚
4. **同步节奏**：每 15~30 分钟更新一次状态
5. **恢复后复盘**：24 小时内输出复盘文档

复盘至少包含：
- 事件时间线
- 根因
- 处置动作
- 预防措施（含 owner 和截止日期）

---

## 12) 跨端联动规范（Client / Server / Shared）

- 改契约先改 `packages/shared`
- 后端接口变更需同步前端适配计划
- 前端限制不可替代后端权限校验
- 涉及数据库字段变化，必须说明兼容策略

---

## 13) 文档协同规范

### 必更新场景
- 权限模型变化
- API 契约变化
- 核心流程变化（创建/分析/导出/删除）
- 发布流程/回滚策略变化

### 建议文档分工
- `AGENTS.md`：技术与执行硬规则
- `AGENTS.team.md`：团队协作与治理规则
- 重大变更补充：`docs/decision-*.md`（如后续引入 docs 目录）

---

## 14) 新成员上手清单（Onboarding）

入项首日完成：
- 拉取项目并成功本地启动
- 理解核心链路（创建→分析→预览→导出）
- 阅读 `AGENTS.md` 与 `AGENTS.team.md`
- 跟随一次真实需求从评审到上线
- 认领一个低风险任务并完成交付

---

## 15) 会议与输出模板

## 15.1 需求评审模板
- 目标：
- 用户价值：
- 验收标准：
- 风险：
- 里程碑：
- Owner：

## 15.2 PR 评审模板
- 改了什么：
- 为什么改：
- 风险点：
- 如何验证：
- 回滚方式：

## 15.3 发布公告模板
- 版本：
- 时间：
- 变更摘要：
- 风险提示：
- 回滚预案：
- 负责人：

---

## 16) 持续改进机制

每个迭代至少完成一项流程改进：
- 减少交接成本
- 缩短定位时间
- 提升验收覆盖
- 降低线上故障率

改进项必须有：
- 指标（如何衡量是否改善）
- Owner
- 截止时间
- 复盘结论

---

## 17) 与执行模式的关系

- 涉及本文件更新、权限/导出/归属等高风险改动：按 `extra high` 执行
- 常规协作文本补充、流程文案细化：按 `medium` 执行

> 团队共识：流程不是为了增加负担，而是为了 **降低返工、减少事故、提升交付确定性**。
